<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>AusDigtial Transaction Access Point (TAP) 2.0 Specification - AusDigital Standards by ausdigital</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css">

    <link rel="apple-touch-icon" sizes="57x57" href="/images/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="/images/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/images/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
</head>

<body>

<header class="header">
    <div class="header-line">
        <div class="wrapper">
            <div id="mobile-menu-wrapper" class="mobile-menu">
                <button id="hamburger-menu" class="hamburger-menu">
                    <span>toggle menu</span>
                </button>
                <div id="mobile-menu" style="display: none;">
                    
                    <ul class="sidebar-menu">
    
    <li class="menu-title">Benefits</li>
    <li><a  href="/business-case/">A Business Case</a></li>
    <li class="menu-title">Technical Specs</li>
    <li><a  href="/ausdigital-idp/">Identity Provider (IDP)</a></li>
    <li><a  href="/ausdigital-dcl/">Capability Locator (DCL)</a></li>
    <li><a  href="/ausdigital-dcp/">Capability Publisher (DCP)</a></li>
    <li><a class="active" href="/ausdigital-tap/">Access Point (TAP)</a></li>
    <li><a  href="/ausdigital-tap-gw/">TAP Gateway (TAP-GW)</a></li>
    <li><a  href="/ausdigital-nry/">Notary (NRY)</a></li>
    <li><a  href="/ausdigital-syn/">UBL Syntax (SYN)</a></li>
    <li class="menu-title">Semantic Specs</li>
    <li><a  href="/ausdigital-code/">Code Lists Mgmt (CODE)</a></li>
    <li><a  href="/ausdigital-bill/">Billing Process (BILL)</a></li>
    <li><a  href="/ausdigital-po/">Purchase Orders (PO)</a></li>
    <li><a  href="/ausdigital-ship/">Fulfillment (SHIP)</a></li>
    <li class="menu-title">Governance</li>
    <li><a  href="/governance-model/">Governance Model</a></li>
    <li class="menu-title">Community</li>
    <li><a href="http://eepurl.com/ctZ6hf" target="_blank">Newsletter (subscribe)</a></li>
    <li><a href="http://chat.ausdigital.org" target="_blank">Chat (join team)</a></li>
    <li><a href="https://github.com/ausdigital/" target="_blank">GitHub</a></li>
</ul>
                </div>
            </div>
            <a href="/" class="logo"><img src="/images/logo.png" alt="AusDigital"><span>AusDigital.org</span></a>
            <div class="header-search">
                <script>
                    (function() {
                        var cx = '017892665596304004128:tj19kxwel_m';
                        var gcse = document.createElement('script');
                        gcse.type = 'text/javascript';
                        gcse.async = true;
                        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                        var s = document.getElementsByTagName('script')[0];
                        s.parentNode.insertBefore(gcse, s);
                    })();
                </script>
                <gcse:search></gcse:search>
            </div>
            
        </div>
    </div>
    <div class="header-content">
        <div class="wrapper">
            <img src="/images/logo.png" alt="AusDigital">
            <div class="header-text-box">
                <div class="header-name">AusDigital Standards</div>
                <div class="header-tagline">Business to Business data exchange open standards community </div>
            </div>
        </div>
    </div>
</header>
<script type="text/javascript">
    document.getElementById('hamburger-menu').onclick = function() {
        var nf = document.getElementById('mobile-menu');

        // Show and hide menu items when toggle is clicked
        if(nf.style.display==='none') {
            nf.style.display = 'block';
        }
        else {
            nf.style.display = 'none';
        }
    };

    window.addEventListener('click', function(e){
        if (!document.getElementById('mobile-menu-wrapper').contains(e.target)){
            document.getElementById('mobile-menu').style.display= 'none';
        }
    });
</script>

<div class="main-wrapper">
    <div class="main-content">
        <div class="page-sidebar">
            <ul class="sidebar-menu">
    
    <li class="menu-title">Benefits</li>
    <li><a  href="/business-case/">A Business Case</a></li>
    <li class="menu-title">Technical Specs</li>
    <li><a  href="/ausdigital-idp/">Identity Provider (IDP)</a></li>
    <li><a  href="/ausdigital-dcl/">Capability Locator (DCL)</a></li>
    <li><a  href="/ausdigital-dcp/">Capability Publisher (DCP)</a></li>
    <li><a class="active" href="/ausdigital-tap/">Access Point (TAP)</a></li>
    <li><a  href="/ausdigital-tap-gw/">TAP Gateway (TAP-GW)</a></li>
    <li><a  href="/ausdigital-nry/">Notary (NRY)</a></li>
    <li><a  href="/ausdigital-syn/">UBL Syntax (SYN)</a></li>
    <li class="menu-title">Semantic Specs</li>
    <li><a  href="/ausdigital-code/">Code Lists Mgmt (CODE)</a></li>
    <li><a  href="/ausdigital-bill/">Billing Process (BILL)</a></li>
    <li><a  href="/ausdigital-po/">Purchase Orders (PO)</a></li>
    <li><a  href="/ausdigital-ship/">Fulfillment (SHIP)</a></li>
    <li class="menu-title">Governance</li>
    <li><a  href="/governance-model/">Governance Model</a></li>
    <li class="menu-title">Community</li>
    <li><a href="http://eepurl.com/ctZ6hf" target="_blank">Newsletter (subscribe)</a></li>
    <li><a href="http://chat.ausdigital.org" target="_blank">Chat (join team)</a></li>
    <li><a href="https://github.com/ausdigital/" target="_blank">GitHub</a></li>
</ul>
        </div>
        <div class="page-content docs-content">
            <div class="spec-header">
                
                <ul>
                    <li>Spec ID: <p>ausdigital-tap/2</p>
</li>
                    <li><p><img src="http://rfc.unprotocols.org/spec:2/COSS/raw.svg" alt="raw" /></p>
</li>
                    <li>Editor: <p><a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#099;&#104;&#114;&#105;&#115;&#116;&#111;&#112;&#104;&#101;&#114;&#046;&#100;&#046;&#103;&#111;&#117;&#103;&#104;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;">Chris Gough</a></p>
</li>
                    <li>Contributors: <p><a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#115;&#116;&#101;&#118;&#101;&#110;&#046;&#099;&#097;&#112;&#101;&#108;&#108;&#064;&#103;&#111;&#115;&#111;&#117;&#114;&#099;&#101;&#046;&#099;&#111;&#109;&#046;&#097;&#117;">Steven Capell</a></p>
</li>
                </ul>
            </div>
            <div class="specs-toc">
    <!--<div class="specs-toc-title">Table of contents</div>-->
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h2"><a href="#goals">Goals</a></li>
<li class="toc-entry toc-h2"><a href="#status">Status</a></li>
<li class="toc-entry toc-h2"><a href="#glossary">Glossary:</a></li>
<li class="toc-entry toc-h2"><a href="#licence">Licence</a></li>
<li class="toc-entry toc-h2"><a href="#change-process">Change Process</a></li>
<li class="toc-entry toc-h2"><a href="#language">Language</a></li>
<li class="toc-entry toc-h1"><a href="#introduction-1">Introduction</a></li>
<li class="toc-entry toc-h2"><a href="#dependencies">Dependencies</a></li>
<li class="toc-entry toc-h2"><a href="#tap-protocol-overview">TAP Protocol Overview</a></li>
<li class="toc-entry toc-h1"><a href="#tap-protocol-details">TAP Protocol Details</a></li>
<li class="toc-entry toc-h2"><a href="#receiving-a-business-message">Receiving a business message</a></li>
<li class="toc-entry toc-h2"><a href="#sending-a-business-message">Sending a business message</a></li>
<li class="toc-entry toc-h3"><a href="#sign-the-business-document">Sign the Business Document</a></li>
<li class="toc-entry toc-h3"><a href="#create-hash-of-signed-business-document">Create hash of signed business document</a></li>
<li class="toc-entry toc-h3"><a href="#create-cyphertext-of-signed-business-document">Create cyphertext of signed business document</a></li>
<li class="toc-entry toc-h4"><a href="#note-about-published-keys">Note about published keys</a></li>
<li class="toc-entry toc-h3"><a href="#message-format">Message format</a></li>
<li class="toc-entry toc-h3"><a href="#compose-message-example">Compose Message Example</a></li>
<li class="toc-entry toc-h3"><a href="#generate-signature">Generate signature</a></li>
<li class="toc-entry toc-h3"><a href="#posting-the-message-to-the-recipient-tap">Posting the message to the recipient TAP</a></li>
<li class="toc-entry toc-h2"><a href="#receipt-and-technical-acknowledgement">Receipt and Technical Acknowledgement</a></li>
<li class="toc-entry toc-h1"><a href="#related-material">Related Material</a></li>
</ul>
</div>
            <h2 id="introduction">Introduction</h2>

<p>This document describes a protocol for exchanging formal documents (such as invoices)
between businesses. TAP is a secure, decentralised, peer to peer architecture where gateways
are optional and minimally trusted.</p>

<h2 id="goals">Goals</h2>

<p>The primary goal of the Transaction Access Point (TAP) 2.0 Specification is to TBA.</p>

<p>The Transaction Access Point (TAP) 2.0 Specification defines TBA.</p>

<h2 id="status">Status</h2>

<p>This spec is an early draft for consuiltation.</p>

<p>This specification aims to support the Australian Digital Business Council
<a href="http://ausdigital.org">eInvoicing initiative</a>, and is under active
development at
<a href="https://github.com/ausdigital/ausdigital-tap">https://github.com/ausdigital/ausdigital-tap</a>.</p>

<p>Comments and feedback are encouraged and welcome. Pull requests with improvements are welcome too.</p>

<h2 id="glossary">Glossary:</h2>

<table>
  <thead>
    <tr>
      <th>phrase</th>
      <th>Definition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ausdigital-tap/2</td>
      <td>Version 2 of the <a href="http://ausdigital.org">AusDigtial</a> <a href="http://ausdigital.org/specs/ausdigital-tap/2.0/">TAP</a> specification</td>
    </tr>
    <tr>
      <td>ausdigital-tapgw/1</td>
      <td>Version 1 of the <a href="http://ausdigital.org">AusDigtial</a> <a href="http://ausdigital.org/specs/ausdigital-tap-gw/1.0/">TAP-GW</a> specification</td>
    </tr>
    <tr>
      <td>ausdigital-bill/1</td>
      <td>Version 1 of the <a href="http://ausdigital.org">AusDigtial</a> <a href="http://ausdigital.org/specs/ausdigital-bill/1.0/">BILL</a> specification</td>
    </tr>
    <tr>
      <td>ausdigital-dcl/1</td>
      <td>Version 1 of the <a href="http://ausdigital.org">AusDigtial</a> <a href="http://ausdigital.org/specs/ausdigital-dcl/1.0">DCL</a> specification</td>
    </tr>
    <tr>
      <td>ausdigital-dcp/1</td>
      <td>Version 1 of the <a href="http://ausdigital.org">AusDigtial</a> <a href="http://ausdigital.org/specs/ausdigital-dcp/1.0">DCP</a> specification</td>
    </tr>
    <tr>
      <td>ausdigital-nry/1</td>
      <td>Version 1 of the <a href="http://ausdigital.org">AusDigtial</a> <a href="http://ausdigital.org/specs/ausdigital-nry/1.0/">NRY</a> specification</td>
    </tr>
    <tr>
      <td>ausdigital-idp/1</td>
      <td>Version 1 of the <a href="http://ausdigital.org">AusDigtial</a> <a href="http://ausdigital.org/specs/ausdigital-idp/1.0/">IDP</a> specification</td>
    </tr>
  </tbody>
</table>

<h2 id="licence">Licence</h2>

<p>Copyright (c) 2016, 2017 the Editor and Contributors. All rights reserved.</p>

<p>This Specification is free software; you can redistribute it and/or modify it under the
terms of the GNU General Public License as published by the Free Software Foundation;
either version 3 of the License, or (at your option) any later version.</p>

<p>This Specification is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE. See the GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License along with this program;
if not, see <a href="http://www.gnu.org/licenses">http://www.gnu.org/licenses</a>.</p>

<h2 id="change-process">Change Process</h2>

<p>This document is governed by the <a href="http://rfc.unprotocols.org/spec:2/COSS/">2/COSS</a> (COSS).</p>

<h2 id="language">Language</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”,
“RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in
RFC 2119.</p>

<h1 id="introduction-1">Introduction</h1>

<p>The Transaction Access Point (TAP) is a persistently connected “peer” capable of sending and
receiving business documents, such as invoices. It interacts with other TAPs following the
protocol specified in this document. The TAP is an autonomous agent in business-to-business
document exchange.</p>

<p>A TAP might be provided by a commercial ledger service, or maintained as part of an
independent business system.</p>

<p>The TAP specification has two parts. The main part (ausdigital-tap/2) defines the protocol all peers
must follow (and interfaces they must provide) to send and receive business documents. The
second part is an optional gateway specification (ausdigital-tapgw/1), which defines a client-server
protocol for trusted business system components (e.g. ledger services) to interact with independent TAP service providers in a generic way.</p>

<h2 id="dependencies">Dependencies</h2>

<p>The messages sent between TAPs carry semantic payloads. Currently, these include
ausdigital-bill/1.
That specification is maintained independently in the
<a href="https://github.com/ausdigital/ausdigital-bill">https://github.com/ausdigital/ausdigital-bill</a>
repository. Future semantic payloads may be supported without change to the protocol.</p>

<p>All TAPs depend on the following Services:</p>

<ul>
  <li>ausdigital-dcl/1</li>
  <li>ausdigital-dcp/1</li>
  <li>ausdigital-nry/1</li>
</ul>

<p>TAPGW providers also depend on the
ausdigital-idp/1. TAPs do not need to
authenticate when they interact with each other, due to use of well known cryprograpic keys
and service endpoint addresses.</p>

<h2 id="tap-protocol-overview">TAP Protocol Overview</h2>

<p>In this protocol, a Transaction Access Point (TAP) is a business system component that sends and receives business messages. The TAP Protocol describes how one TAP sends the message, and how the other TAP responds when a message is received.</p>

<p>The message is sent to the receiving TAP using HTTP POST operation, with a <code class="highlighter-rouge">Content-Type: multipart/form-data</code> body. This body contains two parts, <code class="highlighter-rouge">message</code> and <code class="highlighter-rouge">signature</code>.</p>

<p>The <code class="highlighter-rouge">message</code> part is a mixture of cleartext metadata (used by TAPs) and enciphered payload (used by trusted business system components). The cleartext metadata does not contain sensitive business information, whereas access to the business-sensitive information within the payload is not necessary for participating in the TAP protocol.</p>

<p>The <code class="highlighter-rouge">signature</code> part is created by a business system component trusted by the sender (with access to the sender’s private key material). The signature can be used as a unique identifier of the message contents (e.g. transmitted document id).</p>

<p><img src="./tap_overview_post.png" alt="Illustration of POST body" title="Business document sent to TAP" /></p>

<p>Receiving TAPs may also use the signature as a filter (messages with invalid signatures MAY be dropped by receiving TAPs, rather than delivered). This allows TAPs to buffer trusted components from anonymous denial of service attacks.</p>

<p>When a valid message is received, the TAP issues an HTTP 200 status and returns a response body with <code class="highlighter-rouge">Content-Type: application/json</code>, containing received message information and optional HATEOS-style list of callback URLs.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TapMessage"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tap-generated UUID of the message"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"documentHash"</span><span class="p">:</span><span class="w"> </span><span class="s2">"proxied field 'hash' from message.json document"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"deliveryStatus"</span><span class="p">:</span><span class="w"> </span><span class="s2">"processing"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>See the TAP Protocol Details chapter for more information.</p>

<h1 id="tap-protocol-details">TAP Protocol Details</h1>

<p>The TAP Protocol is a very simple REST API. One business sends a message directly to another business’ TAP endpoint (discovered via the <code class="highlighter-rouge">ausdigital-dcp/1</code> protocol):</p>

<ul>
  <li>The sender uses the HTTP POST verb (over HTTPS) to send the signed message to a TAP,</li>
  <li>The sender MUST use HTTPS,</li>
  <li>The TAP MUST reply with received message info or error response,</li>
  <li>The TAP MAY notarize messages that it receives (per <code class="highlighter-rouge">ausdigital-nry/1</code>).</li>
</ul>

<h2 id="receiving-a-business-message">Receiving a business message</h2>

<p>When a message is sent to a TAP endpoint, it MUST validate the message before delivering it to the recipient:</p>

<ul>
  <li>If the message does not validate against the JSON schema, return HTTP error (400).</li>
  <li>If the sender participant identifier is not valid, an HTTP 200 may be returned but the message MUST NOT be delivered.</li>
  <li>If the signing key for the message is not in the sender participant identifier’s published list of signing keys (and non-revoked at the time of signing, per <code class="highlighter-rouge">ausdigital/DCP</code> protocol), an HTTP 200 may be returned but the message MUST NOT be delivered.</li>
  <li>If the message signature is not made with the signing key of the message, and HTTP 200 may be returned but the message MUST NOT be delivered.</li>
</ul>

<h2 id="sending-a-business-message">Sending a business message</h2>

<p>Pre-requisites:</p>

<ul>
  <li>Sender knows their own business identity, and has access to their own private key.</li>
  <li>Sender knows the recipient business identity (e.g. ABN).</li>
  <li>Sender knows recipient Digital Capability Publisher (DCP) address, which can be discovered from business identity using ausdigital-dcl/1.</li>
  <li>Sender knows appropriate TAP endpoint address for the intended message type (discovered via DCP lookup).</li>
  <li>Sender knows appropriate recipient public key (discovered via DCP lookup).</li>
  <li>The sender has a valid cleartext (not encrypted) business document to send (e.g. an invoice), encoding the appropriate business semantics (e.g. UBL2.0) in an appropriate format (e.g. json).</li>
</ul>

<p>The process is:</p>

<ul>
  <li>Create hash of the business document</li>
  <li>Sign the business document</li>
  <li>Create cyphertext of the signed business document</li>
  <li>Create message.json file</li>
  <li>Generate message.json signature</li>
  <li>POST message.json and signature to the recipient TAP</li>
</ul>

<h3 id="sign-the-business-document">Sign the Business Document</h3>

<p>The TAP protocol MAY be used to transport any business message in any format. It MAY be used to transport messages compliant with Billing Semantics. Messages SHOULD be formatted as XML or JSON and UTF-8 encoded.</p>

<p>Message signing is interpreted in the sense used by the OpenPGP standard (RFC4880), however strict compliance would involve 3DES algorithm which is not supported. Approved signing algorithms are those determined <code class="highlighter-rouge">--safe</code> by the <em>modern</em> (Eliptic Curve Cryptography compatible) distribution of GnuPG. This is version 2.1.15 at the time of writing, but any stable release at or above v2.1.15 is appropriate.</p>

<p>The following public key formats are supported:</p>

<ul>
  <li>ECC (RFC6637)</li>
  <li>RSA (RFC4880)</li>
</ul>

<p>Business documents compression is discouraged, because it is redundant due to compression at the HTTP layer (per RFC2616 and RFC1952). Business documents MAY be compressed with ZIP (RFC1951), ZLIB (RFC1950), or BZip2 algorithms.</p>

<p>The business document and signature are combined into a single ASCII-Armoured file per RFC4880 (i.e. including use of Radix-64 to convert UTF-8 to 7 bit ASCII in the signed file). For example, assuming the current working directory contains a business document <code class="highlighter-rouge">doc.json</code>, a signed document <code class="highlighter-rouge">signed_doc.txt</code> can be created using the GnuPG command line program like this:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>gpg2 <span class="se">\</span>
 --output <span class="s2">"signed_doc.txt"</span> <span class="se">\</span>
 --clearsign <span class="s2">"doc.json"</span>
</code></pre>
</div>

<p>Please see (TODO: examples) for more detailed explanation and real-world examples.</p>

<h3 id="create-hash-of-signed-business-document">Create hash of signed business document</h3>

<p>The following hash algorithms are approved for use:</p>

<ul>
  <li>SHA256 (default)</li>
  <li>SHA384</li>
  <li>SHA512</li>
  <li>BLAKE2b</li>
  <li>BLAKE2s</li>
</ul>

<p>It is not necessary to sign the hash, because the entire message is signed.</p>

<p>This hash is of the cleartext “business document” before the signing. When the recipient decrypts the business document, they are able to verify the hash. If the recipient-generated hash does not match the hash in the message, the recipient MUST NOT provide business acceptance of the document.</p>

<p>The hash is calculated before the signing, so, if sender for some reasons calculates 2 different signatures using 2 different keys - the hash is still the same.</p>

<p><strong>TODO: this is a very strange paragraph.</strong>
If a 3rd party is presented with a copy of the message (including this hash), and with a copy of the signed business document, they are able to verify that the hash of the signed business document matches the hash in the message. That way, if the recipient provides business acceptance of the document, the third party knows the document that was accepted matches the cleartext document they were shown (despite the fact the 3rd party does not have access to recipient key material).</p>

<p>Assuming the current working directory contains a document <code class="highlighter-rouge">doc.txt</code>, a hash of the signed document <code class="highlighter-rouge">doc.hash</code> can be created with openssl like this:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>openssl dgst -sha256 -out <span class="s2">"doc.hash"</span> <span class="s2">"doc.txt"</span>
</code></pre>
</div>

<p>For example, if your doc.txt contains text <code class="highlighter-rouge"><span class="p">{</span><span class="nt">"document_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"invoice"</span><span class="p">}</span></code> (ending with newline character) the result is:
<code class="highlighter-rouge">
SHA256(doc.txt)= 14a62c86caa60bb3987248e93e51cacd46392562475738d3213b44f457ee163b
</code>
where <code class="highlighter-rouge">14a62c86caa60bb3987248e93e51cacd46392562475738d3213b44f457ee163b</code> is a document hash in plan SHA256 HEX format.</p>

<h3 id="create-cyphertext-of-signed-business-document">Create cyphertext of signed business document</h3>

<p>The message does not contain plaintext of the business document (signed or otherwise). It contains the hash of the plaintext (as per above), and cyphertext of the signed plaintext document.</p>

<p>The cyphertext is created using public key cryptography, using the appropriate public key for the recipient business endpoint. The public parts of these keypairs are discoverable using the appropriate DCP for each business identifier URNs, which is discoverable using the global DCL. Public keys MUST be published in ASCII-Armoured form in the DCP.</p>

<p>Example:</p>

<ul>
  <li>Alice sends document to Bob</li>
  <li>Both Alice and Bob has public/private keypairs</li>
  <li>Both Alice and Bob published their public keys to the DCP</li>
  <li>Alice signs plaintext document by Alice’s private key, having signed document as an output</li>
  <li>Alice encyphers signed document using Bob’s public key, having encyphered value as a result</li>
  <li>Nobody except Bob can decypher the encyphered value (because only Bob owns his private keys)
 …</li>
  <li>When message is received, Bob decyphers the encyphered value using his public key</li>
  <li>After that Bob validates the digital signature, using Alice’s public key</li>
  <li>
    <p>If everything went fine Bob can be sure that:</p>

    <ol>
      <li>Only he decyphered the document</li>
      <li>This document has been signed by Alice.</li>
    </ol>
  </li>
</ul>

<p>Use of mature, well-known and extensively scrutinised cryptography implementations is strongly encouraged. The following examples use GnuPG, although any compliant RFC4880 implementation could be used in an equivalent way.</p>

<p>Assuming the recipient’s public key is not already in the sender’s GnuPG keyring, but is in the current working directory as <code class="highlighter-rouge">recipient.gpg</code>, it can be added to the sender’s GnuPG keyring like this:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>gpg2 --import <span class="s2">"recipient.gpg"</span>
</code></pre>
</div>

<p>With GnuPG, this is only necessary once. Subsequent messages to the same recipient can skip the key importing step.</p>

<h4 id="note-about-published-keys">Note about published keys</h4>

<p>Implementation-specific section.</p>

<p>Once the recipient’s key has been added to the sender’s keyring, and assuming the current working directory contains a signed document <code class="highlighter-rouge">signed_doc.txt</code>, and the user namespace identifier of the recipient public key is <code class="highlighter-rouge">91f68ffafa1288ad55cb3e61e937870fb5598cc098e125fe29412ab3047f15e1@dcp.testpoint.io</code> then cyphertext of signed business document can be created with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>gpg2 --armour \
 --output "cyphertext.gpg"
 --encrypt \
 --recipient 91f68ffafa1288ad55cb3e61e937870fb5598cc098e125fe29412ab3047f15e1@dcp.testpoint.io \
 signed_doc.txt
</code></pre>
</div>

<p>This will create a file <code class="highlighter-rouge">cyphertext.gpg</code> in the current working directory, which has ASCII-Armour encoding (suitable for inclusion in a json document).</p>

<h3 id="message-format">Message format</h3>

<p>Typical TAP message is:
<code class="highlighter-rouge"><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nt">"cyphertext"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"hash"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"sender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"reference"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></p>

<ul>
  <li>“cyphertext” contains encrypted signed document</li>
  <li>encrypted by receiver public key</li>
  <li>signed by sender private key</li>
  <li>“hash” contains cryptographic hash of the document (before signing and encryption)</li>
  <li>“sender” contains unique participant identifier of client
    <ul>
      <li>sender must make his public keys, used for signing operations, available in the DCP</li>
    </ul>
  </li>
  <li>“reference” contains additional information about conversations or original message (which this one is replies to)</li>
</ul>

<h3 id="compose-message-example">Compose Message Example</h3>

<p>The <code class="highlighter-rouge">message</code> part is a mixture of cleartext metadata (used by TAPs) and enciphered payload (used by trusted business system components). The cleartext metadata does not contain sensitive business information, whereas access to the business-sensitive information within the payload is not necessary for participating in the TAP protocol.</p>

<p>The message part does not need to be in any kind of canonical form. It MUST be a valid json document.</p>

<p>Assuming the current working directory contains:</p>

<ul>
  <li><code class="highlighter-rouge">cyphertext.gpg</code>, containing encrypted signed business document in ASCII-Armour format</li>
  <li><code class="highlighter-rouge">signed_doc.hash</code>, containing digest of the signed business document</li>
  <li><code class="highlighter-rouge">reference.txt</code>, containing arbitrary string related to the document</li>
  <li><code class="highlighter-rouge">sender.txt</code>, containing the URN of the business identifier of the sender</li>
</ul>

<p>Then the following python script will create <code class="highlighter-rouge">message.json</code> file containing the cyphertext and associated metadata in json format.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">read_cyphertext</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">"cyphertext.gpg"</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">read_hash</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">"signed_doc.hash"</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">read_reference</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">"reference.txt"</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">read_sender</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">"sender.txt"</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">compose_message</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">"message.json"</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'cyphertext'</span><span class="p">:</span> <span class="n">read_cyphertext</span><span class="p">(),</span>
        <span class="s">'hash'</span><span class="p">:</span> <span class="n">read_hash</span><span class="p">(),</span>
        <span class="s">'reference'</span><span class="p">:</span> <span class="n">read_reference</span><span class="p">(),</span>
        <span class="s">'sender'</span><span class="p">:</span> <span class="n">read_sender</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="n">result_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">result_file</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
    <span class="n">result_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">result_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">compose_message</span><span class="p">()</span>
</code></pre>
</div>

<h3 id="generate-signature">Generate signature</h3>

<p>The <code class="highlighter-rouge">signature</code> part is created by a business system component trusted by the sender (with access to the sender’s private key material). The signature can also be used to uniquely identify the message contents.</p>

<p>Assuming the current working directory contains the message (as <code class="highlighter-rouge">message.json</code>), the following command will create a signature <code class="highlighter-rouge">message.sig</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>gpg2 --output message.sig --sign message.json
</code></pre>
</div>

<p>Implementation note: the easiest way to make sure that specific key is used for signature is to have only single private key in GPG keyring. GPG for linux support custom keyring location.</p>

<h3 id="posting-the-message-to-the-recipient-tap">Posting the message to the recipient TAP</h3>

<p>Layered on top of HTTP Protocol:</p>

<ul>
  <li>MUST use HTTPS (RFC2818).</li>
  <li>MUST use only <code class="highlighter-rouge">Content-Type: multipart/form-data</code> (RFC2388)</li>
  <li>MAY explicitly declare <code class="highlighter-rouge">Content-Transfer-Encoding: base64</code></li>
  <li>MUST NOT rely on additional TAP-related information in HTTP headers, such as message or conversation identifiers.</li>
</ul>

<p>The message is sent to the receiving TAP using HTTP POST operation. The posted body contains two parts, named <code class="highlighter-rouge">message</code> and <code class="highlighter-rouge">signature</code>.</p>

<p>Assuming the current working directory contains the message (as message.json) and signature (as message.sig), the following curl command will post the message to the recipient TAP (replace <code class="highlighter-rouge">&lt;TAP_URL&gt;</code> with HTTPS URL discovered from the Service Metadata Publisher).</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -X POST <span class="se">\</span>
 -H <span class="s2">"Content-Type: multipart/form-data"</span> <span class="se">\</span>
 -F <span class="s2">"message=@message.json"</span> <span class="se">\</span>
 -F <span class="s2">"signature=@message.sig"</span> <span class="se">\</span>
 &lt;TAP_URL&gt;
</code></pre>
</div>

<h2 id="receipt-and-technical-acknowledgement">Receipt and Technical Acknowledgement</h2>

<p>When a valid message is received, the TAP issues an HTTP 200 status and returns a response body with <code class="highlighter-rouge">Content-Type: application/json</code>, containing information about the message and optional HATEOS-style list of callback URLs.
Check the <a href="http://ausdigital.org/specs/ausdigital-tap/2.0/api">API</a>  for possible responses, success and errors.</p>

<p>TODO:</p>

<ul>
  <li>explain callback URLs</li>
  <li>explain callback semantic URLs</li>
</ul>

<h1 id="related-material">Related Material</h1>

<ul>
  <li>AusDigital Transaction Access Point Implementation Guide (v1.0, available <a href="https://github.com/ausdigital/ausdigital-tap/blob/master/docs/1.0/Digital_Capability_Publisher_Implementation_Guide_v1.0.pdf">here</a>), which provides background to the <a href="http://ausdigital.org">AusDigital</a> community process.</li>
  <li><a href="https://github.com/ausdigital/ausdigital-tap/issues/">GitHub issues</a> for collaborating on the development of the TAP.</li>
  <li>A reference <a href="http://testpoint.io/tap">TAP service</a> (for testing and development purposes).</li>
  <li>Free, Open-Source Software <a href="https://github.com/test-point/testpoint-tap">TAP implementation</a>.</li>
  <li>An automated <a href="https://github.com/test-point/testpoint-tap">TAP test suite</a>.</li>
</ul>

        </div>
    </div>
</div>
<footer class="footer">
    <a href="/" class="footer-logo"><img src="/images/logo.png" alt="AusDigital"><span>AusDigital.org</span></a>
    <ul class="footer-menu">
        <li><a href="http://ausdigital.org/about">About AusDigital</a></li>
        <li><a href="https://github.com/ausdigital" target="_blank">Github</a></li>
        <li><a href="http://eepurl.com/ctZ6hf" target="_blank">Newsletter</a></li>
        <li><a href="http://chat.ausdigital.org/" target="_blank">Join</a> <a href="https://ausdigital.slack.com/messages/general/" target="_blank">team</a></li>
    </ul>
    <div class="footer-credits">
        This page was generated by GitHub Pages.
        Comments, issues and suggestions are welcome in the <a href="https://github.com/ausdigital/ausdigital.github.io/issues/new">ticket system</a>.
        Pull requests welcome in the <a href="https://github.com/ausdigital/ausdigital.github.io/">site repository</a>.
    </div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79579364-2', 'auto');
  ga('send', 'pageview');

</script>

<script src="/js/anchor.min.js"></script>
<script>
    anchors.add('h1, h2, h3, h4, h5');
    anchors.remove('.no-anchor, .page-content > h1:first-child');
</script>
</body>
</html>